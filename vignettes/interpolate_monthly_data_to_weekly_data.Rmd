---
title: "Interpolate monthly data to weekly data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{interpolate_monthly_data_to_weekly_data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r setup, message = FALSE}
library(VEinterpolation)
library(ggplot2)
library(dplyr)
library(gridExtra)
```

## Introduction

This vignette demonstrates an approach to interpolate weekly data from 8-week data for vaccine effectiveness using a 3-step strategy: **nlxb** for starting values, **nls** for parameter optimization, and **bootstrap** for covariance matrix estimation. 

## Understanding the 3-Step Strategy

The 3-step fitting strategy consists of:

1. **Step 1: nlxb** - Uses the `nlsr` package to find good starting values for the parameters
2. **Step 2: nls** - Uses the standard `nls` function with the starting values from step 1
3. **Step 3: Bootstrap** - Uses parametric bootstrap to estimate the covariance matrix and parameter uncertainty


## Sample Data

We use a toy dataset provided in the package, containing 8-weeks estimates of vaccine effectiveness (VE) for 12 months.

```{r sample_data}
data("sample_8_weeks_data")

head(sample_8_weeks_data)
```

```{r, fig.width=8, fig.height=6}
ggplot(sample_8_weeks_data, aes(x = date_min, y = 1 - estimate)) +
    geom_point() +
    geom_errorbar(aes(ymin = 1 - CIhigh, ymax = 1 - CIlow)) +
    theme_minimal() +
    labs(x = "Date", y = "Vaccine Effectiveness")
```

## Creating Individual Decay Models

```{r}
nbootstrap <- 100
seed_to_use <- 666
```

### Exponential Decay Model

```{r exponential_model}
# Create exponential model using the R6 class
exponential_model <- DecayModel$new(
    name = "exponential",
    decay_function = exponential_decay(),
    param_config = list(
        start = c(VE0 = 0.7, decay_rate = 0.1),
        lower = c(0.01, 0.001),
        upper = c(0.99, 1.0),
        names = c("VE0", "decay_rate")
    )
)

# Fit the model using 3-step strategy with custom bootstrap settings
exponential_result <- exponential_model$fit_3step(
    estimate = sample_8_weeks_data$estimate,
    ci_low = sample_8_weeks_data$CIlow,
    ci_up = sample_8_weeks_data$CIhigh,
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    nboot = nbootstrap,
    seed = seed_to_use
)
```

```{r, echo = FALSE, eval=TRUE}
# View the results
cat("Exponential Model Results:\n")
cat("Coefficients:", paste(names(exponential_model$get_optimal_params()),
    "=", round(exponential_model$get_optimal_params(), 4),
    collapse = ", "
), "\n")
cat("BIC:", exponential_model$get_bic(), "\n")
cat("Covariance Matrix:\n")
print(exponential_result$covariance_matrix)
```

### Logistic Decay Model

```{r logistic_model}
# Create logistic model using the R6 class
logistic_model <- DecayModel$new(
    name = "logistic",
    decay_function = logistic_decay(),
    param_config = list(
        start = c(VE0 = 0.7, decay_rate = 0.1, constant = 0.5),
        lower = c(0.01, 0.001, 0.01),
        upper = c(0.99, 1.0, 2.0),
        names = c("VE0", "decay_rate", "constant")
    )
)

# Fit the model using 3-step strategy
logistic_result <- logistic_model$fit_3step(
    estimate = sample_8_weeks_data$estimate,
    ci_low = sample_8_weeks_data$CIlow,
    ci_up = sample_8_weeks_data$CIhigh,
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    nboot = nbootstrap,
    seed = seed_to_use
)
```

```{r, echo = FALSE, eval=TRUE}
# View the results
cat("Logistic Model Results:\n")
cat("Coefficients:", paste(names(logistic_model$get_optimal_params()),
    "=", round(logistic_model$get_optimal_params(), 4),
    collapse = ", "
), "\n")
cat("BIC:", logistic_model$get_bic(), "\n")
cat("Covariance Matrix:\n")
print(logistic_result$covariance_matrix)
```

## Visualizing Individual Models

```{r plot_individual_models, fig.width=8, fig.height=6}
# Plot exponential model
p1 <- exponential_model$plot_optimal(
    estimate = sample_8_weeks_data$estimate,
    ci_low = sample_8_weeks_data$CIlow,
    ci_up = sample_8_weeks_data$CIhigh,
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    title = "Exponential Decay Model (3-Step)",
    color = "red",
    age_group = "65-79",
    site = "Somewhere",
    season = "2023-2024",
    outcome = "Some outcome"
)

# Plot logistic model
p2 <- logistic_model$plot_optimal(
    estimate = sample_8_weeks_data$estimate,
    ci_low = sample_8_weeks_data$CIlow,
    ci_up = sample_8_weeks_data$CIhigh,
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    title = "Logistic Decay Model (3-Step)",
    color = "blue",
    age_group = "65-79",
    site = "Somewhere",
    season = "2023-2024",
    outcome = "Some outcome"
)
grid.arrange(p1, p2, ncol = 2)
```

## Comparing multiple models at once

```{r model_comparison}
comparison_result <- compare_decay_models(
    model_names = c("exponential", "logistic"),
    estimate = sample_8_weeks_data$estimate,
    ci_low = sample_8_weeks_data$CIlow,
    ci_up = sample_8_weeks_data$CIhigh,
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    nboot = nbootstrap,
    seed = seed_to_use
)

# View comparison results
cat("Model Comparison Summary:\n")
print(comparison_result$summary)

# Find best model based on BIC
best_model_bic <- get_best_model(comparison_result, criterion = "bic")
cat("\nBest model based on BIC:", best_model_bic$model_name, "\n")
cat("Best BIC:", best_model_bic$criterion, "\n")
```

## Model Comparison Plot

```{r model_comparison_plot, fig.width=8, fig.height=6}
# Create comparison plot using BIC criterion
comparison_plot <- plot_model_comparison(
    comparison_result = comparison_result,
    estimate = sample_8_weeks_data$estimate,
    ci_low = sample_8_weeks_data$CIlow,
    ci_up = sample_8_weeks_data$CIhigh,
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    criterion = "bic",
    age_group = "65-79",
    site = "Somewhere",
    season = "2023-2024",
    outcome = "Some outcome"
)

print(comparison_plot)
```


## Generate many weekly VE samples with uncertainty from covariance matrix

The new `generate_VE_based_on_boot_fit` method allows us to generate VE samples based on the bootstrap covariance matrix, providing uncertainty quantification:

```{r bootstrap_uncertainty}
# Generate VE samples based on bootstrap fit
ve_samples <- best_model_bic$model$generate_VE_based_on_boot_fit(
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    n_weekly_ve_to_generate = 1000
)

print(head(ve_samples, 10))
```


### VE with Uncertainty Bands

```{r ve_uncertainty_plot, fig.width=10, fig.height=6}
# Plot VE with uncertainty bands
uncertainty_plot <- best_model_bic$model$plot_VE_with_uncertainty(
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    title = "Logistic Model VE with uncertainty"
)

print(uncertainty_plot)
```

### Show individual VE samples

```{r some_ve_plot, fig.width=10, fig.height=6}
# Plot individual bootstrap samples
some_ve_plot <- best_model_bic$model$plot_ve_samples(
    periods_starts = sample_8_weeks_data$date_min,
    periods_ends = sample_8_weeks_data$date_max,
    n_samples = 5,
    title = "Individual VE Samples - Logistic Model",
    alpha = 1
)

print(some_ve_plot)
```

